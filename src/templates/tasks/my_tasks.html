
{% extends "base.html" %}
{% block content %}
<div class="tasks-container">
  <div class="header">
    <h1>My Tasks</h1>
    {% if user.role == "admin" %}
      <button class="add-task-btn" onclick="openAddTaskModal()">+ Add Task</button>
    {% endif %}
  </div>

  <div class="task-list">
  {% if tasks %}
   {% for task in tasks %}
     <div class="task-item"
          style="border-left: 5px solid {{ 'green' if task.status == 'done' else ('orange' if task.status == 'in-progress' else '#007bff') }}">
       <div class="task-header">
         <h3>{{ task.title }}</h3>
         <div class="task-actions">
           <button onclick="openTaskModal({{ task.id }}, '{{ task.title }}', '{{ task.description or '' }}', '{{ task.status }}', '{{ task.due_date }}', '{{ task.assignee_id }}')" class="edit-btn">Edit</button>
           {% if user.role == "admin" or task.assignee_id == user.id %}
             <button onclick="deleteTask({{ task.id }})" class="delete-btn">Delete</button>
           {% endif %}
         </div>
       </div>
       <p>{{ task.description or 'No description' }}</p>

      <!-- ‚úÖ Updated Status Line -->
       <p class="task-status-line">
         <strong>Status:</strong>
         {% if task.status == "done" %}
           <span class="status done">Done ‚úÖ</span>
         {% elif task.status == "in-progress" %}
           <span class="status progress">In Progress üîÑ</span>
         {% else %}
           <span class="status todo">To Do üìù</span>
         {% endif %}
       </p>

       {% if task.assignee %}
         <p><strong>Assigned to:</strong> {{ task.assignee.name }}</p>
       {% endif %}
       {% if task.assigned_by %}
         <p><strong>Assigned by:</strong> {{ task.assigned_by.name }}</p>
       {% endif %}
       {% if task.due_date %}
         <p><strong>Due:</strong> {{ task.due_date }}</p>
       {% endif %}
     </div> <!-- ‚úÖ This closes each task-item -->
  {% endfor %}
{% else %}
  <p>No tasks found.</p>
{% endif %}




    
</div>

<!-- Modal: Edit Task -->
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeTaskModal()">&times;</span>
    <h2>Edit Task</h2>
    <form id="editTaskForm" method="POST">
      <label>Title</label>
      <input type="text" name="title" id="taskTitle" required>

      <label>Description</label>
      <textarea name="description" id="taskDescription"></textarea>

      <label>Status</label>
      <select name="status" id="taskStatus">
        <option value="todo">To Do</option>
        <option value="in-progress">In Progress</option>
        <option value="done">Done</option>
      </select>

      {% if user.role == "admin" %}
        <label>Assign to</label>
        <select name="assignee_id" id="taskAssignee">
          <option value="">Unassigned</option>
          {% for u in users %}
            <option value="{{ u.id }}">{{ u.name }}</option>
          {% endfor %}
        </select>

        <label>Due Date</label>
        <input type="date" name="due_date" id="taskDueDate">
      {% else %}
        <!-- employee keeps their assignment -->
        <input type="hidden" name="assignee_id" value="{{ user.id }}">
      {% endif %}

      <button type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Modal: Add Task (Admin only) -->
{% if user.role == "admin" %}
<div id="addTaskModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAddTaskModal()">&times;</span>
    <h2>Create New Task</h2>
    <form id="addTaskForm" method="POST" action="/add_task">
      <label>Title</label>
      <input type="text" name="title" required>

      <label>Description</label>
      <textarea name="description"></textarea>

      <label>Assign to</label>
      <select name="assignee_id">
        <option value="">Unassigned</option>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name }}</option>
        {% endfor %}
      </select>

      <label>Due Date</label>
      <input type="date" name="due_date">

      <button type="submit">Create</button>
    </form>
  </div>
</div>
{% endif %}

<style>
.tasks-container { width: 80%; margin: 2em auto; }
.header { display: flex; justify-content: space-between; align-items: center; }
.add-task-btn {
  background-color: #007bff;
  color: white;
  padding: 8px 14px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
.add-task-btn:hover { background-color: #0056b3; }

.task-item {
  background: #fff;
  padding: 1em;
  margin-bottom: 1em;
  border-radius: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
}
.modal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
}
.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  width: 400px;
  border-radius: 8px;
}
.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}
.edit-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
}
.task-actions {
  display: flex;
  gap: 8px;
}

.delete-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
}

.delete-btn:hover {
  background: #b02a37;
}




.task-status-line {
  margin-top: 8px;
  font-size: 15px;
}

.status {
  font-weight: bold;
}

.status.todo {
  color: #007bff;
}

.status.progress {
  color: #ff9800;
}

.status.done {
  color: #28a745;
}

</style>

<script>
function openTaskModal(id, title, desc, status, due, assigneeId) {
  const modal = document.getElementById("taskModal");
  document.getElementById("editTaskForm").action = `/update_task/${id}`;
  document.getElementById("taskTitle").value = title || "";
  document.getElementById("taskDescription").value = desc || "";
  document.getElementById("taskStatus").value = status || "todo";
  if (document.getElementById("taskAssignee")) {
    document.getElementById("taskAssignee").value = assigneeId || "";
  }
  if (due && document.getElementById("taskDueDate")) {
    document.getElementById("taskDueDate").value = due;
  }
  modal.style.display = "block";
}
function closeTaskModal() {
  document.getElementById("taskModal").style.display = "none";
}
function openAddTaskModal() {
  document.getElementById("addTaskModal").style.display = "block";
}
function closeAddTaskModal() {
  document.getElementById("addTaskModal").style.display = "none";
}
window.onclick = function(e) {
  const addModal = document.getElementById("addTaskModal");
  const editModal = document.getElementById("taskModal");
  if (e.target === addModal) addModal.style.display = "none";
  if (e.target === editModal) editModal.style.display = "none";
}
async function deleteTask(taskId) {
  if (!confirm("Are you sure you want to delete this task?")) return;

  const response = await fetch(`/delete_task/${taskId}`, {
    method: "POST"
  });

  if (response.ok) {
    alert("Task deleted successfully!");
    location.reload();
  } else {
    alert("Failed to delete task.");
  }
}

</script>
{% endblock %}
